<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PTZ</title>
</head>
<body>

<button id="btn" onclick="setup()">Request Serial Port</button>


<div id="frame">
    <div id="camera"></div>
</div>

<script>
    if ("serial" in navigator) {
        // The Web Serial API is supported.
    } else {
        alert("Web Serial API is not supported");
    }
    let port;

    async function setup() {
        port = await navigator.serial.requestPort();
        await port.open({baudRate: 9600});
        console.log(port);
        reader();
        PTZ.startInterval();
    }


    async function reader() {
        while (port.readable) {
            const reader = port.readable.getReader();
            try {
                while (true) {
                    const {value, done} = await reader.read()
                    if (done) {
                        // |reader| has been canceled.
                        break;
                    }
                    // Do something with |value|...
                    PTZ.isKnownCommand(value);

                }
            } catch (error) {
                // Handle |error|...
            } finally {
                reader.releaseLock();
            }
        }
    }


    const PTZ = {
        camera: document.getElementById("camera"),
        frame: document.getElementById("frame"),
        cameraT: null,
        commands: {
            move: {
                // Byte 5 and 6 are the speed of the movement
                up: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x03, 0x01, 0xFF]),
                down: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x03, 0x02, 0xFF]),
                left: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x01, 0x03, 0xFF]),
                right: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x02, 0x03, 0xFF]),
                upLeft: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x01, 0x01, 0xFF]),
                upRight: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x02, 0x01, 0xFF]),
                downLeft: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x01, 0x02, 0xFF]),
                downRight: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x02, 0x02, 0xFF]),
                stop: new Uint8Array([0x81, 0x01, 0x06, 0x01, 0x00, 0x00, 0x03, 0x03, 0xFF]),
            },
            zoom: {

                // Byte 5 is the speed of the zoom
                zoomIn: new Uint8Array([0x81, 0x01, 0x04, 0x07, 0x20, 0xFF]),
                zoomOut: new Uint8Array([0x81, 0x01, 0x04, 0x07, 0x30, 0xFF]),
                zoomStop: new Uint8Array([0x81, 0x01, 0x04, 0x07, 0x00, 0xFF]),
            },
            settings: {
                turnOn: new Uint8Array([0x81, 0x01, 0x04, 0x07, 0x02, 0xFF]),
                turnOff: new Uint8Array([0x81, 0x01, 0x04, 0x07, 0x03, 0xFF]),

            },
        },

        dir: {
            moveX: 0,
            moveY: 0,
            speedX: 0,
            speed: 0,
        },
        pos: {
            x: 200,
            y: 200,
        },
        size: 50,
        maxSize: 300,
        minSize: 10,
        zoom: {
            dir: 0,
            speed: 1,
        },

        isKnownCommand: function (command) {
            // check if the command is known, ignore the speed byte
            if (command[0] !== 0x81) {
                console.log("Unknown command");
                return false;
            }

            // check if the command is a movement command
            if (command[1] === 0x01 && command[2] === 0x06 && command[3] === 0x01 && command[8] === 0xFF) {
                // find the command, but ignore the Byte 5 and 6
                for (let key in PTZ.commands.move) {
                    if (command[6] === PTZ.commands.move[key][6] && command[7] === PTZ.commands.move[key][7]) {
                        //convert the speed to decimal
                        const SpeedX = Number(command[4].toString(16));
                        const SpeedY = Number(command[4].toString(16));

                        if (SpeedX > 18 || SpeedX < 0) {
                            console.log("Invalid SpeedX: " + SpeedX);
                            return false;
                        }
                        if (SpeedY > 18 || SpeedY < 0) {
                            console.log("Invalid SpeedY: " + SpeedY);
                            return false;
                        }

                        this.dir.speedY = SpeedY;
                        this.dir.speedX = SpeedX;

                        this.dir.moveX = command[6];
                        this.dir.moveY = command[7];

                        return true;
                    }
                }
            }

            // check if the command is a zoom command
            if (command[1] === 0x01 && command[2] === 0x04 && command[3] === 0x07 && command[5] === 0xFF) {
                // find the command, but ignore the Byte 5
                const dir = command[4].toString(16)[0];
                // const speed = command[4].toString(16)[1] ?? 0;
                const speed = 3;
                this.zoom.speed = parseInt(speed, 16);
                this.zoom.dir = dir;
                console.log(`${this.zoom.dir}  ${this.zoom.speed}`);
            }
        },

        startInterval: function () {
            this.cameraT = this.camera.style.transform;
            // start the interval to move the camera
            this.interval = setInterval(this.moveCamera, 50);
        },

        moveCamera: function () {
            // console.log("Moving Camera");
            // move the camera in the direction and speed

            if (PTZ.dir.moveY === 1) {
                // console.log("Moving Up");
                PTZ.pos.y -= PTZ.dir.speedY;
            } else if (PTZ.dir.moveY === 2) {
                // console.log("Moving Down");
                PTZ.pos.y += PTZ.dir.speedY;
            } else {
                PTZ.dir.speedY = 0;
            }

            if (PTZ.dir.moveX === 1) {
                // console.log("Moving Left");
                PTZ.pos.x -= PTZ.dir.speedX;
            } else if (PTZ.dir.moveX === 2) {
                // console.log("Moving Right");
                PTZ.pos.x += PTZ.dir.speedX;
            } else {
                PTZ.dir.speedX = 0;
            }

            // check if out of bounds
            if (PTZ.pos.y < 0) {
                PTZ.pos.y = 0;
            } else if (PTZ.pos.y > PTZ.frame.clientHeight - PTZ.camera.clientHeight) {
                PTZ.pos.y = PTZ.frame.clientHeight - PTZ.camera.clientHeight;
            }
            if (PTZ.pos.x < 0) {
                PTZ.pos.x = 0;
            } else if (PTZ.pos.x > PTZ.frame.clientWidth - PTZ.camera.clientWidth) {
                PTZ.pos.x = PTZ.frame.clientWidth - PTZ.camera.clientWidth;
            }

            PTZ.camera.style.top = PTZ.pos.y + "px";
            PTZ.camera.style.left = PTZ.pos.x + "px";

            //zoom
            if (PTZ.zoom.dir == 2) {
                console.log("Zooming In");
                PTZ.size += PTZ.zoom.speed;
            } else if (PTZ.zoom.dir == 3) {
                PTZ.size -= PTZ.zoom.speed;
            }


            if (PTZ.size < PTZ.minSize) {
                PTZ.size = PTZ.minSize;
            } else if (PTZ.size > PTZ.maxSize) {
                PTZ.size = PTZ.maxSize;
            }
            PTZ.camera.style.width = PTZ.size + "px";
            PTZ.camera.style.height = PTZ.size + "px";

        },


    }


</script>

</body>

<style>
    *{
        margin: 0;
        padding: 0;
    }
    body {
        height: 100vh;
    }
    #frame {
        width: 100%;
        height: 100%;
        /*border: 2px solid black;*/
        background-color: #646562;
        position: relative;
    }

    #camera {
        width: 50px;
        height: 50px;
        background-color: red;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    #btn {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 9;
        padding: 5px;
        border-radius: 10px;
    }
</style>


</html>